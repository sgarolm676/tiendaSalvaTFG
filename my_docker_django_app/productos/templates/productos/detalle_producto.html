<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>{{ producto.marca }} - {{ producto.modelo }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap + FontAwesome + Google Fonts -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --dark: #1e293b;
      --light: #f8fafc;
      --gray: #94a3b8;
      --success: #10b981;
      --danger: #ef4444;
      --border-radius: 12px;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: #f1f5f9;
      color: var(--dark);
      line-height: 1.6;
    }

    .tech-header {
      background: linear-gradient(135deg, #1e3a8a 0%, #2563eb 100%);
      color: white;
      border-radius: var(--border-radius);
      padding: 1rem;
      margin-bottom: 2rem;
      box-shadow: var(--shadow);
    }

    .tech-card {
      border: none;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      transition: transform 0.2s ease;
      background-color: white;
    }

    .tech-card:hover {
      transform: translateY(-5px);
    }

    .product-image {
      border-radius: var(--border-radius);
      object-fit: contain;
      background-color: #f8fafc;
      padding: 1rem;
      max-height: 400px;
    }

    .product-title {
      font-weight: 700;
      color: var(--dark);
      margin-bottom: 0.5rem;
    }

    .product-subtitle {
      color: var(--gray);
      font-weight: 500;
      margin-bottom: 1.5rem;
    }

    .price-tag {
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--primary);
      font-family: 'Roboto Mono', monospace;
    }

    .stock-badge {
      font-size: 0.85rem;
      padding: 0.35rem 0.75rem;
      border-radius: 20px;
    }

    .btn-tech {
      border-radius: 8px;
      font-weight: 600;
      padding: 0.75rem 1.5rem;
      transition: all 0.2s ease;
      letter-spacing: 0.5px;
    }

    .btn-primary-tech {
      background-color: var(--primary);
      border-color: var(--primary);
    }

    .btn-primary-tech:hover {
      background-color: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }

    .btn-outline-tech {
      border: 2px solid var(--primary);
      color: var(--primary);
    }

    .btn-outline-tech:hover {
      background-color: var(--primary);
      color: white;
    }

    .specs-list {
      list-style-type: none;
      padding-left: 0;
    }

    .specs-list li {
      padding: 0.5rem 0;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
    }

    .specs-list li:last-child {
      border-bottom: none;
    }

    .spec-label {
      font-weight: 500;
      color: var(--gray);
    }

    .spec-value {
      font-weight: 600;
    }

    .comment-card {
      border-left: 3px solid var(--primary);
      transition: all 0.2s ease;
    }

    .comment-card:hover {
      transform: translateX(5px);
    }

    .star-rating {
      color: #f59e0b;
      font-size: 1.1rem;
    }

    .customization-section {
      background-color: white;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .customization-header {
      background-color: var(--dark);
      color: white;
      padding: 1rem;
      cursor: pointer;
    }

    .form-control-tech {
      border-radius: 8px;
      padding: 0.75rem 1rem;
      border: 1px solid #cbd5e1;
    }

    .form-control-tech:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 0.25rem rgba(37, 99, 235, 0.25);
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      object-fit: cover;
      border-radius: 50%;
      border: 2px solid var(--primary);
    }

    .dropdown-menu-tech {
      border-radius: 8px;
      border: none;
      box-shadow: var(--shadow);
    }

    @media (max-width: 768px) {
      .product-image {
        max-height: 300px;
      }
    }
  </style>
</head>

<body>
  <!-- Encabezado -->
  <div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <a href="{% url 'lista_productos' %}" class="btn btn-outline-tech d-flex align-items-center">
        <i class="fas fa-arrow-left me-2"></i> Volver
      </a>

      <h3 class="fw-bold m-0 text-center flex-grow-1" style="color: var(--primary);">TechCore</h3>

      <div class="d-flex align-items-center">
        <a href="{% url 'ver_carrito' %}" class="position-relative me-3">
          <i class="fas fa-shopping-bag fa-lg" style="color: var(--primary);"></i>
          <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
            {{ request.user.carrito.items.count }}
          </span>
        </a>
        <div class="dropdown">
          <a href="#" class="dropdown-toggle d-flex align-items-center text-decoration-none" data-bs-toggle="dropdown">
            <img src="{% if user.perfil.imagen and user.perfil.imagen.url != '/media/avatars/default.jpeg' %}{{ user.perfil.imagen.url }}{% else %}https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/icons/person-circle.svg{% endif %}" 
                 class="user-avatar me-2">
          </a>
          <ul class="dropdown-menu dropdown-menu-end dropdown-menu-tech">
            <li><a class="dropdown-item" href="{% url 'editar_perfil' %}"><i class="fas fa-user-cog me-2"></i>Perfil</a></li>
            <li><a class="dropdown-item" href="{% url 'configuracion' %}"><i class="fas fa-cog me-2"></i>Configuración</a></li>
            <li><hr class="dropdown-divider"></li>
            <li>
              <form id="logout-form" action="{% url 'logout' %}" method="post" style="display: none;">{% csrf_token %}</form>
              <a class="dropdown-item text-danger" href="#" onclick="event.preventDefault(); document.getElementById('logout-form').submit();">
                <i class="fas fa-sign-out-alt me-2"></i>Cerrar sesión
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Producto -->
  <div class="container">
    <div class="tech-card mb-4 p-4">
      <div class="row g-4 align-items-center">
        <!-- Imagen del producto -->
        <div class="col-md-6 text-center">
          <img src="{{ producto.imagen.url }}" alt="{{ producto.marca }}" class="product-image img-fluid w-100">
        </div>
        
        <!-- Detalles del producto -->
        <div class="col-md-6">
          <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
              <h1 class="product-title">{{ producto.marca }}</h1>
              <h2 class="product-subtitle">{{ producto.modelo }}</h2>
            </div>
            <span class="stock-badge bg-{% if producto.unidades > 5 %}success{% else %}warning{% endif %} text-white">
              <i class="fas fa-{% if producto.unidades > 5 %}check-circle{% else %}exclamation-triangle{% endif %} me-1"></i>
              {{ producto.unidades }} disponibles
            </span>
          </div>

          <div class="mb-4">
            <span class="price-tag">{{ producto.precio }} €</span>
            {% if producto.precio_original %}
              <span class="text-decoration-line-through text-muted ms-2">{{ producto.precio_original }} €</span>
              <span class="badge bg-danger ms-2">-{{ producto.descuento }}%</span>
            {% endif %}
          </div>

          <ul class="specs-list mb-4">
            <li>
              <span class="spec-label">Color:</span>
              <span class="spec-value">{{ producto.color }}</span>
            </li>
            <li>
              <span class="spec-label">Marca:</span>
              <span class="spec-value">{{ producto.marca }}</span>
            </li>
            <li>
              <span class="spec-label">Modelo:</span>
              <span class="spec-value">{{ producto.modelo }}</span>
            </li>
            <li>
              <span class="spec-label">Envío:</span>
              <span class="spec-value">24-48h <i class="fas fa-truck text-muted ms-1"></i></span>
            </li>
          </ul>

          <form method="post" action="{% url 'agregar_al_carrito' producto.id %}" class="mt-4">
            {% csrf_token %}
            <input type="hidden" name="personalizado" value="False">
            <button type="submit" class="btn btn-primary-tech w-100 btn-tech">
              <i class="fas fa-cart-plus me-2"></i> Añadir al carrito
            </button>
          </form>
        </div>
      </div>
    </div>

    <!-- Personalización -->
    <div class="customization-section mb-4">
      <div class="customization-header d-flex justify-content-between align-items-center" data-bs-toggle="collapse" data-bs-target="#infoProducto">
        <h5 class="m-0"><i class="fas fa-sliders-h me-2"></i> Personalización del producto</h5>
        <i class="fas fa-chevron-down"></i>
      </div>
      <div class="collapse" id="infoProducto">
        <form method="post" enctype="multipart/form-data" class="p-4">
          {% csrf_token %}

          <div class="mb-4">
            <label for="posicion" class="form-label fw-bold mb-3">¿Dónde quieres personalizarlo?</label>
            <select id="posicion" name="posicion" class="form-select form-control-tech">
              <option value="trasera">Parte trasera</option>
              <option value="lateral">Lateral izquierdo</option>
              <option value="frontal">Parte frontal</option>
            </select>
          </div>

          <div class="mb-4">
            <label for="tipo" class="form-label fw-bold mb-3">Tipo de personalización</label>
            <select id="tipo" name="tipo" class="form-select form-control-tech">
              <option value="frase">Texto personalizado</option>
              <option value="imagen">Imagen/logo</option>
              <option value="ambos">Texto e imagen</option>
            </select>
          </div>

          <div id="div-frase" class="mb-4" style="display: none;">
            <label for="frase" class="form-label fw-bold mb-3">Tu texto personalizado</label>
            <input type="text" id="frase" name="frase" class="form-control form-control-tech" placeholder="Ej: #TechLover">
            <small class="text-muted">Máximo 30 caracteres</small>
          </div>

          <div id="div-imagen" class="mb-4" style="display: none;">
            <label for="imagen" class="form-label fw-bold mb-3">Sube tu imagen</label>
            <input type="file" id="imagen" name="imagen" class="form-control form-control-tech">
            <small class="text-muted">Formatos: JPG, PNG (max. 2MB)</small>
          </div>

          <div class="text-center mt-4">
            <button type="submit" class="btn btn-primary-tech btn-tech px-5">
              <i class="fas fa-magic me-2"></i> Aplicar personalización
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Comentarios y valoraciones -->
    <div class="tech-card p-4 mb-4">
      <h4 class="mb-4"><i class="fas fa-comments me-2"></i> Opiniones de clientes</h4>
      
      {% for comentario in comentarios %}
      <div class="comment-card p-3 mb-3 bg-light rounded">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div>
            <strong>{{ comentario.usuario.username }}</strong>
            <span class="star-rating ms-2">
              {% for i in "12345"|make_list %}
                {% if forloop.counter <= comentario.estrellas %}
                  <i class="fas fa-star"></i>
                {% else %}
                  <i class="far fa-star"></i>
                {% endif %}
              {% endfor %}
            </span>
          </div>
          <small class="text-muted">{{ comentario.fecha|date:"d M Y" }}</small>
        </div>
        <p class="mb-0">{{ comentario.texto }}</p>
      </div>
      {% empty %}
      <div class="text-center py-4">
        <i class="far fa-comment-dots fa-3x text-muted mb-3"></i>
        <p class="text-muted">No hay comentarios aún. ¡Sé el primero en opinar!</p>
      </div>
      {% endfor %}

      <hr class="my-4">

      <h5 class="mb-3"><i class="fas fa-edit me-2"></i> Deja tu valoración</h5>
      <form method="post" class="mt-3">
        {% csrf_token %}
        <div class="mb-3">
          <label class="form-label fw-bold">Tu valoración</label>
          <div class="star-rating mb-2">
            {% for i in "12345"|make_list %}
              <i class="far fa-star rating-star" data-value="{{ forloop.counter }}" style="cursor: pointer; font-size: 1.5rem;"></i>
            {% endfor %}
            <input type="hidden" name="estrellas" id="rating-value" value="5">
          </div>
        </div>
        <div class="mb-3">
          <label for="texto" class="form-label fw-bold">Comentario</label>
          <textarea name="texto" class="form-control form-control-tech" rows="3" required></textarea>
        </div>
        <button type="submit" name="comentario_submit" class="btn btn-primary-tech btn-tech">
          <i class="fas fa-paper-plane me-2"></i> Enviar valoración
        </button>
      </form>
    </div>

    <!-- Productos relacionados (opcional) -->
    <div class="tech-card p-4">
      <h4 class="mb-4"><i class="fas fa-random me-2"></i> Productos relacionados</h4>
      <div class="row">
        <!-- Aquí irían productos relacionados -->
        <div class="col-md-3 col-6 mb-3">
          <div class="tech-card h-100 p-3 text-center">
            <img src="https://via.placeholder.com/150" class="img-fluid mb-3" style="height: 120px; object-fit: contain;">
            <h6 class="fw-bold">Producto Relacionado 1</h6>
            <p class="text-primary fw-bold">199,99 €</p>
            <button class="btn btn-outline-tech btn-sm w-100">Ver detalles</button>
          </div>
        </div>
        <!-- Repetir para otros productos -->
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Personalización dinámica
      const posicion = document.getElementById('posicion');
      const tipo = document.getElementById('tipo');
      const fraseDiv = document.getElementById('div-frase');
      const imagenDiv = document.getElementById('div-imagen');

      function actualizarOpciones() {
        if (posicion.value === 'lateral') {
          tipo.value = 'frase';
          tipo.disabled = true;
          mostrarCampoFrase();
        } else {
          tipo.disabled = false;
          if (tipo.value === 'frase') {
            mostrarCampoFrase();
          } else if (tipo.value === 'imagen') {
            mostrarCampoImagen();
          } else {
            mostrarAmbosCampos();
          }
        }
      }

      function mostrarCampoFrase() {
        fraseDiv.style.display = 'block';
        imagenDiv.style.display = 'none';
      }

      function mostrarCampoImagen() {
        fraseDiv.style.display = 'none';
        imagenDiv.style.display = 'block';
      }

      function mostrarAmbosCampos() {
        fraseDiv.style.display = 'block';
        imagenDiv.style.display = 'block';
      }

      posicion.addEventListener('change', actualizarOpciones);
      tipo.addEventListener('change', function () {
        if (this.value === 'frase') {
          mostrarCampoFrase();
        } else if (this.value === 'imagen') {
          mostrarCampoImagen();
        } else {
          mostrarAmbosCampos();
        }
      });

      actualizarOpciones();

      // Sistema de valoración con estrellas
      const stars = document.querySelectorAll('.rating-star');
      const ratingValue = document.getElementById('rating-value');

      stars.forEach(star => {
        star.addEventListener('click', function() {
          const value = this.getAttribute('data-value');
          ratingValue.value = value;
          
          stars.forEach((s, index) => {
            if (index < value) {
              s.classList.remove('far');
              s.classList.add('fas');
            } else {
              s.classList.remove('fas');
              s.classList.add('far');
            }
          });
        });
      });
    });
  </script>
</body>
</html>